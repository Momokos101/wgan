# 项目架构说明

## 📁 项目目录结构

```
WGANGPProject-master/
├── configs/                  # 配置文件目录
├── database/                 # 数据库文件
├── data/                     # 数据输出目录
├── docs/                     # 文档目录
├── logs/                     # 训练日志
├── model_weights/            # 模型权重保存目录
├── nn/                       # 神经网络模型代码
├── resources/                # 资源文件（PDF等）
├── scripts/                  # 可执行脚本
├── sequence/                 # 数据处理模块
└── venv/                     # Python虚拟环境
```

---

## 📂 目录详细说明

### `configs/` - 配置文件目录

**作用**：存放所有配置文件，项目参数集中管理

**文件说明**：
```
configs/
├── __init__.py               # 包初始化文件
├── config_vcu.py            # 主配置文件（自动导入所有子配置）
├── config_vcu_base.py      # 基础配置（共享，修改前需讨论）
├── config_vcu_data.py       # 数据配置（后端负责人）
├── config_vcu_model.py     # 模型配置（GAN架构负责人）
└── config_vcu_train.py     # 训练配置（GAN应用负责人）
```

**使用方式**：
```python
from configs.config_vcu import *  # 导入所有配置
```

---

### `database/` - 数据库目录

**作用**：存放SQLite数据库文件

**文件说明**：
```
database/
└── db.db                    # VCU测试数据数据库
```

**数据库结构**：
- `test_runs` 表：存储测试运行数据
- 字段：`run_id`, `round_id`, `actual_input`, `actual_output`, `expected_output`等

---

### `data/` - 数据输出目录

**作用**：存放处理后的数据和生成的结果

**文件说明**：
```
data/
└── vcu/
    ├── train_voltages.npy        # 训练集电压序列
    ├── train_conditions.npy      # 训练集条件向量
    ├── train_labels.npy          # 训练集异常标签
    ├── test_voltages.npy         # 测试集电压序列
    ├── test_conditions.npy       # 测试集条件向量
    ├── test_labels.npy           # 测试集异常标签
    ├── metadata.json             # 元数据（最大序列长度等）
    └── generated_sequences_*.txt # 生成的序列（十六进制格式）
```

---

### `docs/` - 文档目录

**作用**：存放项目文档

**文件说明**：
```
docs/
├── 01-成员分工.md            # 成员分工说明
├── 02-项目架构说明.md        # 项目架构说明（本文件）
└── 03-README.md              # 环境配置和运行指南
```

---

### `logs/` - 训练日志目录

**作用**：存放训练过程中的日志文件

**文件说明**：
```
logs/
└── vcu/
    └── training_*.log        # 训练日志（损失值、训练配置等）
```

---

### `model_weights/` - 模型权重目录

**作用**：存放训练好的模型权重

**文件说明**：
```
model_weights/
└── vcu/
    ├── *_generator.weights.h5    # 生成器权重
    └── *_discriminator.weights.h5 # 判别器权重
```

---

### `nn/` - 神经网络模型代码

**作用**：GAN模型的核心实现

**文件说明**：
```
nn/
├── model.py                  # 基础模型类（NetModel）
│   └── 定义生成器和判别器的基类接口
│
├── conv1d.py                 # Conv1D模型实现
│   ├── Conv1D_Model类：继承NetModel
│   ├── generator_simple()：生成器网络
│   └── discriminator_simple()：判别器网络
│
├── trainer.py                # 训练器基类
│   └── Trainer类：定义训练流程和模型保存
│
├── wd_trainer.py             # WGAN-GP训练器
│   └── WassersteinTrainer类：实现WGAN-GP训练逻辑
│
├── optimizer.py              # 优化器配置
│   └── Optimizer类：管理优化器和学习率调度
│
├── scale_model.py            # 模型包装类
│   └── ScaleModel类：包装Conv1D_Model，提供统一接口
│
└── load_model.py             # 模型加载工具
    └── load_model()函数：加载训练好的模型权重
```

**核心类说明**：
- `NetModel`：基础模型类，定义生成器和判别器的接口
- `Conv1D_Model`：使用1D卷积的GAN模型实现
- `WassersteinTrainer`：WGAN-GP训练器，实现梯度惩罚
- `ScaleModel`：模型包装类，提供统一的训练和生成接口

---

### `sequence/` - 数据处理模块

**作用**：数据加载、异常检测、数据预处理

**文件说明**：
```
sequence/
├── db_loader.py              # 数据库加载器
│   └── VcuDataLoader类：
│       ├── 从数据库读取测试数据
│       ├── 提取CC2电压序列
│       ├── 提取输出字段
│       └── 异常检测（detect_anomalies()）
│
└── vcu_data_process.py      # 数据处理器
    └── VcuDataProcessor类：
        ├── 数据归一化/反归一化
        ├── 以异常点为中心提取上下文
        ├── 提取电压特征（震荡顶峰、连续极大值等）
        ├── 编码异常类型
        └── 构建条件向量（9维）
```

**核心方法说明**：
- `VcuDataLoader.load_sequences_by_round()`：按轮次加载数据
- `VcuDataLoader.detect_anomalies()`：检测异常数据
- `VcuDataProcessor.extract_context_around_anomaly()`：提取异常点上下文
- `VcuDataProcessor.extract_voltage_features()`：提取电压特征
- `VcuDataProcessor.build_sequence_pairs()`：构建训练数据对

---

### `scripts/` - 可执行脚本

**作用**：存放所有可执行的Python脚本和Shell脚本

**文件说明**：
```
scripts/
├── vcu/                      # VCU相关脚本
│   ├── train_vcu.py         # 训练脚本
│   │   └── 主函数：加载数据、构建模型、训练、保存模型
│   │
│   ├── generate_vcu.py      # 生成脚本（使用训练好的模型）
│   │   └── 主函数：加载模型、条件生成、序列评分、输出十六进制
│   │
│   ├── generate_vcu_simple.py # 生成脚本（使用未训练模型）
│   │   └── 快速生成测试序列（用于测试）
│   │
│   ├── test_vcu_data.py     # 数据测试脚本
│   │   └── 测试数据加载和异常检测
│   │
│   └── test_context_extraction.py # 上下文提取测试
│       └── 测试异常点上下文提取功能
│
└── utils/                    # 工具脚本
    ├── run.sh                # 主运行脚本（推荐使用）
    │   └── 统一入口，执行各种命令
    │
    └── check_environment.py  # 环境检查脚本
        └── 检查Python版本、依赖、数据库、配置等
```

**运行方式**：
```bash
# 使用运行脚本（推荐）
./scripts/utils/run.sh train
./scripts/utils/run.sh generate

# 或直接运行Python脚本
python scripts/vcu/train_vcu.py
python scripts/vcu/generate_vcu.py
```

---

### `resources/` - 资源文件

**作用**：存放项目相关的PDF文档、图片等资源

**文件说明**：
```
resources/
├── GAN方案汇报.pdf
├── 基于GAN的唤醒-休眠场景智能模糊测试项目计划书.pdf
└── 数据分析总结.pdf
```

---

### `venv/` - Python虚拟环境

**作用**：Python虚拟环境，隔离项目依赖

**注意**：此目录通常不提交到Git，通过`.gitignore`忽略

---

## 🔄 数据流程

```
1. 数据库 (database/db.db)
   ↓
2. 数据加载 (sequence/db_loader.py)
   - 读取测试数据
   - 提取CC2电压序列
   - 异常检测
   ↓
3. 数据预处理 (sequence/vcu_data_process.py)
   - 以异常点为中心提取上下文
   - 提取电压特征
   - 编码异常类型
   - 构建条件向量（9维）
   - 归一化电压值
   ↓
4. 训练数据 (data/vcu/*.npy)
   - 电压序列
   - 条件向量
   - 异常标签
   ↓
5. 模型训练 (scripts/vcu/train_vcu.py)
   - 加载数据
   - 构建模型 (nn/scale_model.py)
   - 训练 (nn/wd_trainer.py)
   - 保存模型权重 (model_weights/vcu/*.h5)
   ↓
6. 序列生成 (scripts/vcu/generate_vcu.py)
   - 加载模型权重
   - 条件生成（根据异常类型和电压特征）
   - 序列评分
   - 输出十六进制格式
   ↓
7. 生成结果 (data/vcu/generated_sequences_*.txt)
```

---

## 📊 核心模块关系

```
VcuDataLoader (sequence/db_loader.py)
    ↓ 提供数据
VcuDataProcessor (sequence/vcu_data_process.py)
    ↓ 提供处理后的数据
ScaleModel (nn/scale_model.py)
    ├─ 使用 Conv1D_Model (nn/conv1d.py)
    ├─ 使用 WassersteinTrainer (nn/wd_trainer.py)
    └─ 使用 Optimizer (nn/optimizer.py)
    ↓ 提供模型接口
train_vcu.py / generate_vcu.py (scripts/vcu/)
    ↓ 使用模型
生成结果
```

---

## 🎯 关键文件作用速查

| 文件 | 作用 | 负责人 |
|------|------|--------|
| `sequence/db_loader.py` | 数据库读取和异常检测 | 后端开发 |
| `sequence/vcu_data_process.py` | 数据预处理和特征提取 | 后端开发 |
| `nn/model.py` | 基础模型类 | GAN架构开发 |
| `nn/conv1d.py` | GAN模型实现 | GAN架构开发 |
| `nn/wd_trainer.py` | WGAN-GP训练器 | GAN架构开发 |
| `scripts/vcu/train_vcu.py` | 训练脚本 | GAN应用开发 |
| `scripts/vcu/generate_vcu.py` | 生成脚本 | GAN应用开发 |
| `configs/config_vcu_data.py` | 数据配置 | 后端开发 |
| `configs/config_vcu_model.py` | 模型配置 | GAN架构开发 |
| `configs/config_vcu_train.py` | 训练配置 | GAN应用开发 |

---

## 📝 总结

- **`configs/`**：配置文件，项目参数
- **`database/`**：原始数据
- **`sequence/`**：数据处理（后端负责）
- **`nn/`**：模型实现（GAN架构负责）
- **`scripts/vcu/`**：训练和生成脚本（GAN应用负责）
- **`data/`**：处理后的数据和生成结果
- **`model_weights/`**：训练好的模型
- **`docs/`**：项目文档

每个目录和文件都有明确的职责，便于团队协作！

